/* http://keith-wood.name/countdown.html
   Countdown for jQuery v1.5.4.
   Written by Keith Wood (kbwood{at}iinet.com.au) January 2008.
   Dual licensed under the GPL (http://dev.jquery.com/browser/trunk/jquery/GPL-LICENSE.txt) and 
   MIT (http://dev.jquery.com/browser/trunk/jquery/MIT-LICENSE.txt) licenses. 
   Please attribute the author if you use it. */
/* Display a countdown timer.
   Attach it with options like:
   $('div selector').countdown(
       {until: new Date(2009, 1 - 1, 1, 0, 0, 0), onExpiry: happyNewYear}); */
(function(a){function b(){this.regional=[],this.regional[""]={labels:["Years","Months","Weeks","Days","Hours","Minutes","Seconds"],labels1:["Year","Month","Week","Day","Hour","Minute","Second"],compactLabels:["y","m","w","d"],timeSeparator:":",isRTL:!1},this._defaults={until:null,since:null,timezone:null,serverSync:null,format:"dHMS",layout:"",compact:!1,description:"",expiryUrl:"",expiryText:"",alwaysExpire:!1,onExpiry:null,onTick:null},a.extend(this._defaults,this.regional[""])}function k(b,c){a.extend(b,c);for(var d in c)c[d]==null&&(b[d]=null);return b}var c="countdown",d=0,e=1,f=2,g=3,h=4,i=5,j=6;a.extend(b.prototype,{markerClassName:"hasCountdown",_timer:setInterval(function(){a.countdown._updateTargets()},980),_timerTargets:[],setDefaults:function(a){this._resetExtraLabels(this._defaults,a),k(this._defaults,a||{})},UTCDate:function(a,b,c,d,e,f,g,h){typeof b=="object"&&b.constructor==Date&&(h=b.getMilliseconds(),g=b.getSeconds(),f=b.getMinutes(),e=b.getHours(),d=b.getDate(),c=b.getMonth(),b=b.getFullYear());var i=new Date;return i.setUTCFullYear(b),i.setUTCDate(1),i.setUTCMonth(c||0),i.setUTCDate(d||1),i.setUTCHours(e||0),i.setUTCMinutes((f||0)-(Math.abs(a)<30?a*60:a)),i.setUTCSeconds(g||0),i.setUTCMilliseconds(h||0),i},_attachCountdown:function(b,d){var e=a(b);if(e.hasClass(this.markerClassName))return;e.addClass(this.markerClassName);var f={options:a.extend({},d),_periods:[0,0,0,0,0,0,0]};a.data(b,c,f),this._changeCountdown(b)},_addTarget:function(a){this._hasTarget(a)||this._timerTargets.push(a)},_hasTarget:function(b){return a.inArray(b,this._timerTargets)>-1},_removeTarget:function(b){this._timerTargets=a.map(this._timerTargets,function(a){return a==b?null:a})},_updateTargets:function(){for(var a=0;a<this._timerTargets.length;a++)this._updateCountdown(this._timerTargets[a])},_updateCountdown:function(b,d){var e=a(b);d=d||a.data(b,c);if(!d)return;e.html(this._generateHTML(d)),e[(this._get(d,"isRTL")?"add":"remove")+"Class"]("countdown_rtl");var f=this._get(d,"onTick");f&&f.apply(b,[d._hold!="lap"?d._periods:this._calculatePeriods(d,d._show,new Date)]);var g=d._hold!="pause"&&(d._since?d._now.getTime()<=d._since.getTime():d._now.getTime()>=d._until.getTime());if(g&&!d._expiring){d._expiring=!0;if(this._hasTarget(b)||this._get(d,"alwaysExpire")){this._removeTarget(b);var h=this._get(d,"onExpiry");h&&h.apply(b,[]);var i=this._get(d,"expiryText");if(i){var j=this._get(d,"layout");d.options.layout=i,this._updateCountdown(b,d),d.options.layout=j}var k=this._get(d,"expiryUrl");k&&(window.location=k)}d._expiring=!1}else d._hold=="pause"&&this._removeTarget(b);a.data(b,c,d)},_changeCountdown:function(b,d,e){d=d||{};if(typeof d=="string"){var f=d;d={},d[f]=e}var g=a.data(b,c);if(g){this._resetExtraLabels(g.options,d),k(g.options,d),this._adjustSettings(b,g),a.data(b,c,g);var h=new Date;(g._since&&g._since<h||g._until&&g._until>h)&&this._addTarget(b),this._updateCountdown(b,g)}},_resetExtraLabels:function(a,b){var c=!1;for(var d in b)if(d.match(/[Ll]abels/)){c=!0;break}if(c)for(var d in a)d.match(/[Ll]abels[0-9]/)&&(a[d]=null)},_adjustSettings:function(a,b){var c=this._get(b,"serverSync");c=c?c.apply(a,[]):null;var d=new Date,e=this._get(b,"timezone");e=e==null?-d.getTimezoneOffset():e,b._since=this._get(b,"since"),b._since&&(b._since=this.UTCDate(e,this._determineTime(b._since,null)),b._since&&c&&b._since.setMilliseconds(b._since.getMilliseconds()+d.getTime()-c.getTime())),b._until=this.UTCDate(e,this._determineTime(this._get(b,"until"),d)),c&&b._until.setMilliseconds(b._until.getMilliseconds()+d.getTime()-c.getTime()),b._show=this._determineShow(b)},_destroyCountdown:function(b){var d=a(b);if(!d.hasClass(this.markerClassName))return;this._removeTarget(b),d.removeClass(this.markerClassName).empty(),a.removeData(b,c)},_pauseCountdown:function(a){this._hold(a,"pause")},_lapCountdown:function(a){this._hold(a,"lap")},_resumeCountdown:function(a){this._hold(a,null)},_hold:function(b,d){var e=a.data(b,c);if(e){if(e._hold=="pause"&&!d){e._periods=e._savePeriods;var f=e._since?"-":"+";e[e._since?"_since":"_until"]=this._determineTime(f+e._periods[0]+"y"+f+e._periods[1]+"o"+f+e._periods[2]+"w"+f+e._periods[3]+"d"+f+e._periods[4]+"h"+f+e._periods[5]+"m"+f+e._periods[6]+"s"),this._addTarget(b)}e._hold=d,e._savePeriods=d=="pause"?e._periods:null,a.data(b,c,e),this._updateCountdown(b,e)}},_getTimesCountdown:function(b){var d=a.data(b,c);return d?d._hold?this._calculatePeriods(d,d._show,new Date):d._periods:null},_get:function(b,c){return b.options[c]!=null?b.options[c]:a.countdown._defaults[c]},_determineTime:function(b,c){var d=function(a){var b=new Date;return b.setTime(b.getTime()+a*1e3),b},e=function(b){b=b.toLowerCase();var c=new Date,d=c.getFullYear(),e=c.getMonth(),f=c.getDate(),g=c.getHours(),h=c.getMinutes(),i=c.getSeconds(),j=/([+-]?[0-9]+)\s*(s|m|h|d|w|o|y)?/g,k=j.exec(b);while(k){switch(k[2]||"s"){case"s":i+=parseInt(k[1],10);break;case"m":h+=parseInt(k[1],10);break;case"h":g+=parseInt(k[1],10);break;case"d":f+=parseInt(k[1],10);break;case"w":f+=parseInt(k[1],10)*7;break;case"o":e+=parseInt(k[1],10),f=Math.min(f,a.countdown._getDaysInMonth(d,e));break;case"y":d+=parseInt(k[1],10),f=Math.min(f,a.countdown._getDaysInMonth(d,e))}k=j.exec(b)}return new Date(d,e,f,g,h,i,0)},f=b==null?c:typeof b=="string"?e(b):typeof b=="number"?d(b):b;return f&&f.setMilliseconds(0),f},_getDaysInMonth:function(a,b){return 32-(new Date(a,b,32)).getDate()},_generateHTML:function(b){b._periods=periods=b._hold?b._periods:this._calculatePeriods(b,b._show,new Date);var c=!1,k=0;for(var l=0;l<b._show.length;l++)c|=b._show[l]=="?"&&periods[l]>0,b._show[l]=b._show[l]=="?"&&!c?null:b._show[l],k+=b._show[l]?1:0;var m=this._get(b,"compact"),n=this._get(b,"layout"),o=m?this._get(b,"compactLabels"):this._get(b,"labels"),p=this._get(b,"timeSeparator"),q=this._get(b,"description")||"",r=function(c){var d=a.countdown._get(b,"compactLabels"+periods[c]);return b._show[c]?periods[c]+(d?d[c]:o[c])+" ":""},s=function(c){var d=a.countdown._get(b,"labels"+periods[c]);return b._show[c]?'<span class="countdown_section"><span class="countdown_amount">'+periods[c]+"</span><br/>"+(d?d[c]:o[c])+"</span>":""};return n?this._buildLayout(b,n,m):(m?'<span class="countdown_row countdown_amount'+(b._hold?" countdown_holding":"")+'">'+r(d)+r(e)+r(f)+r(g)+(b._show[h]?this._minDigits(periods[h],2):"")+(b._show[i]?(b._show[h]?p:"")+this._minDigits(periods[i],2):"")+(b._show[j]?(b._show[h]||b._show[i]?p:"")+this._minDigits(periods[j],2):""):'<span class="countdown_row countdown_show'+k+(b._hold?" countdown_holding":"")+'">'+s(d)+s(e)+s(f)+s(g)+s(h)+s(i)+s(j))+"</span>"+(q?'<span class="countdown_row countdown_descr">'+q+"</span>":"")},_buildLayout:function(b,c,k){var l=this._get(b,k?"compactLabels":"labels"),m=function(c){return(a.countdown._get(b,(k?"compactLabels":"labels")+b._periods[c])||l)[c]},n=function(a,b){return Math.floor(a/b)%10},o={desc:this._get(b,"description"),sep:this._get(b,"timeSeparator"),yl:m(d),yn:b._periods[d],ynn:this._minDigits(b._periods[d],2),ynnn:this._minDigits(b._periods[d],3),y1:n(b._periods[d],1),y10:n(b._periods[d],10),y100:n(b._periods[d],100),ol:m(e),on:b._periods[e],onn:this._minDigits(b._periods[e],2),onnn:this._minDigits(b._periods[e],3),o1:n(b._periods[e],1),o10:n(b._periods[e],10),o100:n(b._periods[e],100),wl:m(f),wn:b._periods[f],wnn:this._minDigits(b._periods[f],2),wnnn:this._minDigits(b._periods[f],3),w1:n(b._periods[f],1),w10:n(b._periods[f],10),w100:n(b._periods[f],100),dl:m(g),dn:b._periods[g],dnn:this._minDigits(b._periods[g],2),dnnn:this._minDigits(b._periods[g],3),d1:n(b._periods[g],1),d10:n(b._periods[g],10),d100:n(b._periods[g],100),hl:m(h),hn:b._periods[h],hnn:this._minDigits(b._periods[h],2),hnnn:this._minDigits(b._periods[h],3),h1:n(b._periods[h],1),h10:n(b._periods[h],10),h100:n(b._periods[h],100),ml:m(i),mn:b._periods[i],mnn:this._minDigits(b._periods[i],2),mnnn:this._minDigits(b._periods[i],3),m1:n(b._periods[i],1),m10:n(b._periods[i],10),m100:n(b._periods[i],100),sl:m(j),sn:b._periods[j],snn:this._minDigits(b._periods[j],2),snnn:this._minDigits(b._periods[j],3),s1:n(b._periods[j],1),s10:n(b._periods[j],10),s100:n(b._periods[j],100)},p=c;for(var q=0;q<7;q++){var r="yowdhms".charAt(q),s=new RegExp("\\{"+r+"<\\}(.*)\\{"+r+">\\}","g");p=p.replace(s,b._show[q]?"$1":"")}return a.each(o,function(a,b){var c=new RegExp("\\{"+a+"\\}","g");p=p.replace(c,b)}),p},_minDigits:function(a,b){return a="0000000000"+a,a.substr(a.length-b)},_determineShow:function(a){var b=this._get(a,"format"),c=[];return c[d]=b.match("y")?"?":b.match("Y")?"!":null,c[e]=b.match("o")?"?":b.match("O")?"!":null,c[f]=b.match("w")?"?":b.match("W")?"!":null,c[g]=b.match("d")?"?":b.match("D")?"!":null,c[h]=b.match("h")?"?":b.match("H")?"!":null,c[i]=b.match("m")?"?":b.match("M")?"!":null,c[j]=b.match("s")?"?":b.match("S")?"!":null,c},_calculatePeriods:function(b,c,k){b._now=k,b._now.setMilliseconds(0);var l=new Date(b._now.getTime());b._since&&k.getTime()<b._since.getTime()?b._now=k=l:b._since?k=b._since:(l.setTime(b._until.getTime()),k.getTime()>b._until.getTime()&&(b._now=k=l));var m=[0,0,0,0,0,0,0];if(c[d]||c[e]){var n=a.countdown._getDaysInMonth(k.getFullYear(),k.getMonth()),o=a.countdown._getDaysInMonth(l.getFullYear(),l.getMonth()),p=l.getDate()==k.getDate()||l.getDate()>=Math.min(n,o)&&k.getDate()>=Math.min(n,o),q=function(a){return(a.getHours()*60+a.getMinutes())*60+a.getSeconds()},r=Math.max(0,(l.getFullYear()-k.getFullYear())*12+l.getMonth()-k.getMonth()+(l.getDate()<k.getDate()&&!p||p&&q(l)<q(k)?-1:0));m[d]=c[d]?Math.floor(r/12):0,m[e]=c[e]?r-m[d]*12:0;var s=function(b,c,f){var g=b.getDate()==f,h=a.countdown._getDaysInMonth(b.getFullYear()+c*m[d],b.getMonth()+c*m[e]);return b.getDate()>h&&b.setDate(h),b.setFullYear(b.getFullYear()+c*m[d]),b.setMonth(b.getMonth()+c*m[e]),g&&b.setDate(h),b};b._since?l=s(l,-1,o):k=s(new Date(k.getTime()),1,n)}var t=Math.floor((l.getTime()-k.getTime())/1e3),u=function(a,b){m[a]=c[a]?Math.floor(t/b):0,t-=m[a]*b};return u(f,604800),u(g,86400),u(h,3600),u(i,60),u(j,1),m}}),a.fn.countdown=function(b){var c=Array.prototype.slice.call(arguments,1);return b=="getTimes"?a.countdown["_"+b+"Countdown"].apply(a.countdown,[this[0]].concat(c)):this.each(function(){typeof b=="string"?a.countdown["_"+b+"Countdown"].apply(a.countdown,[this].concat(c)):a.countdown._attachCountdown(this,b)})},a.countdown=new b})(jQuery);